<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Update Recipe History</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 2rem; max-width: 900px; }
  label { display:block; margin-top: 1rem; font-weight:600; }
  input, textarea, button, select { width: 100%; padding:0.6rem 0.75rem; border-radius:10px; border:1px solid #ddd; }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  button.primary { background:#111; color:#fff; cursor:pointer; margin-top: 1rem; }
  a { color:#06c; }
  .muted { color:#666; font-size:0.9rem; }
</style>
</head>
<body>
<h1>üìù Append History Entry</h1>
<p class="muted">Choose a recipe and add a new entry to its <strong>## History</strong> section.</p>

<div class="row">
  <div>
    <label>Recipe file</label>
    <select id="file"></select>
  </div>
  <div>
    <label>Date</label>
    <input id="date" type="date" value="2025-08-29">
  </div>
</div>

<label>Rating (0‚Äì5)</label>
<input id="rating" type="number" min="0" max="5" step="1">

<label>Notes</label>
<textarea id="notes" rows="6" placeholder="What happened this time? Any tweaks for the future‚Ä¶"></textarea>

<button class="primary" id="save">Append</button>
<p id="status"></p>
<p><a href="index.html">‚Üê Back to list</a></p>

<script>
const GH_USER = "rishi.sareen";
const GH_REPO = "rishisareen.github.io";
const GH_FOLDER = "recipes";
const GH_TOKEN = "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";

function getParam(name) {
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}

function encodeBase64Unicode(str) { return btoa(unescape(encodeURIComponent(str))); }
function decodeBase64Unicode(str) { return decodeURIComponent(escape(atob(str))); }

async function listFiles() {
  const url = `https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${GH_FOLDER}`;
  const res = await fetch(url, { headers: { 'Authorization': `token ${GH_TOKEN}` } });
  if (!res.ok) throw new Error('Failed to list files');
  const data = await res.json();
  return data.filter(x => x.type === 'file' && x.name.endsWith('.md')).map(x => x.name).sort();
}

async function getFile(name) {
  const url = `https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${GH_FOLDER}/${name}`;
  const res = await fetch(url, { headers: { 'Authorization': `token ${GH_TOKEN}` } });
  if (!res.ok) throw new Error('Failed to read file');
  return res.json(); // has content (base64) and sha
}

async function putFile(name, content, sha) {
  const url = `https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${GH_FOLDER}/${name}`;
  const body = {
    message: `Append history to ${name}`,
    content: encodeBase64Unicode(content),
    sha
  };
  const res = await fetch(url, {
    method: 'PUT',
    headers: { 'Authorization': `token ${GH_TOKEN}`, 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

function appendHistory(md, entry) {
  const hasHistory = md.match(/^(##\s+History)\s*$/m);
  if (hasHistory) {
    // append as a new list item before EOF
    return md.trimEnd() + `\n\n- **${entry.date}** ‚Äî Rating: ${entry.rating}\\\n  ${entry.notes}\n`;
  } else {
    return md.trimEnd() + `\n\n## History\n\n- **${entry.date}** ‚Äî Rating: ${entry.rating}\\\n  ${entry.notes}\n`;
  }
}

(async function init() {
  const select = document.getElementById('file');
  const preselect = getParam('file');

  try {
    const files = await listFiles();
    for (const f of files) {
      const opt = document.createElement('option');
      opt.value = f; opt.textContent = f;
      select.appendChild(opt);
    }
    if (preselect && files.includes(preselect)) select.value = preselect;
  } catch (e) {
    document.getElementById('status').textContent = '‚ùå ' + e.message;
  }

  document.getElementById('save').addEventListener('click', async () => {
    const name = select.value;
    const date = document.getElementById('date').value;
    const rating = parseInt(document.getElementById('rating').value || '0', 10);
    const notes = (document.getElementById('notes').value || '').trim();

    const status = document.getElementById('status');
    status.textContent = 'Updating‚Ä¶';

    try {
      const file = await getFile(name);
      const md = decodeBase64Unicode(file.content);
      const updated = appendHistory(md, { date, rating, notes });
      await putFile(name, updated, file.sha);
      const link = `/recipes/${name.replace(/\.md$/, '.html')}`;
      status.innerHTML = `‚úÖ Updated. View: <a href="${link}">${link}</a>`;
    } catch (e) {
      status.textContent = '‚ùå ' + e.message;
    }
  });
})();
</script>
</body>
</html>
