<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>New Recipe</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 2rem; max-width: 900px; }
  label { display:block; margin-top: 1rem; font-weight:600; }
  input, textarea, button { width: 100%; padding:0.6rem 0.75rem; border-radius:10px; border:1px solid #ddd; }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  button.primary { background:#111; color:#fff; cursor:pointer; margin-top: 1rem; }
  .help { color:#666; font-size:0.9rem; }
  a { color:#06c; }
</style>
</head>
<body>
<h1>➕ New Recipe</h1>
<p class="help">Creates <code>recipes/YYYY-MM-DD-title.md</code> in <code>rishisareen.github.io</code>. GitHub Pages will render it automatically.</p>

<form id="form">
  <div class="row">
    <div>
      <label>Title</label>
      <input id="title" required placeholder="e.g., Carrot Rice with Chicken">
    </div>
    <div>
      <label>Date</label>
      <input id="date" type="date" value="2025-08-29" required>
    </div>
  </div>

  <label>Tags (comma separated)</label>
  <input id="tags" placeholder="instantpot, chicken, rice">

  <label>Rating (0–5)</label>
  <input id="rating" type="number" min="0" max="5" step="1" value="0">

  <label>Ingredients (Markdown)</label>
  <textarea id="ingredients" rows="6" placeholder="- 1 cup rice\n- 200g chicken\n- …"></textarea>

  <label>Instructions (Markdown)</label>
  <textarea id="instructions" rows="8" placeholder="1. Rinse rice…\n2. Sauté…\n3. Pressure cook…"></textarea>

  <fieldset style="border:1px solid #eee; padding:1rem; border-radius:12px; margin-top:1rem;">
    <legend>Add first history entry (optional)</legend>
    <div class="row">
      <div>
        <label>Made On</label>
        <input id="hdate" type="date" value="2025-08-29">
      </div>
      <div>
        <label>Rating (0–5)</label>
        <input id="hrating" type="number" min="0" max="5" step="1">
      </div>
    </div>
    <label>Notes</label>
    <textarea id="hnotes" rows="4" placeholder="What worked, what to change next time…"></textarea>
  </fieldset>

  <button class="primary" type="submit">Create Recipe</button>
</form>

<p id="status"></p>
<p><a href="index.html">← Back to list</a></p>

<script>
const GH_USER = "rishi.sareen";
const GH_REPO = "rishisareen.github.io";
const GH_FOLDER = "recipes";
const GH_TOKEN = "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";

function slugify(s) {
  return s.toLowerCase().trim()
    .replace(/[^a-z0-9\s-]/g, '')
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-');
}

function encodeBase64Unicode(str) {
  // UTF-8 safe btoa
  return btoa(unescape(encodeURIComponent(str)));
}

async function createFile(path, content, message) {
  const url = `https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${path}`;
  const body = {
    message,
    content: encodeBase64Unicode(content)
  };
  const res = await fetch(url, {
    method: 'PUT',
    headers: {
      'Authorization': `token ${GH_TOKEN}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(body)
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

document.getElementById('form').addEventListener('submit', async (e) => {
  e.preventDefault();
  const title = document.getElementById('title').value.trim();
  const date = document.getElementById('date').value;
  const tags = document.getElementById('tags').value.split(',').map(s => s.trim()).filter(Boolean);
  const rating = parseInt(document.getElementById('rating').value || '0', 10);

  const ing = document.getElementById('ingredients').value.trim();
  const ins = document.getElementById('instructions').value.trim();

  const hdate = document.getElementById('hdate').value;
  const hratingRaw = document.getElementById('hrating').value;
  const hrating = hratingRaw ? parseInt(hratingRaw, 10) : null;
  const hnotes = document.getElementById('hnotes').value.trim();

  const fname = `${date}-${slugify(title)}.md`;
  const path = `${GH_FOLDER}/${fname}`;

  let historyBlock = "";
  if (hdate || hnotes || Number.isInteger(hrating)) {
    historyBlock = `\n\n## History\n\n- **${hdate || date}** — Rating: ${Number.isInteger(hrating) ? hrating : '-'}\\\n  ${hnotes || ''}`;
  }

  const frontMatter = `---\n` +
`title: "${title.replace(/"/g, '\"')}"` + `\n` +
`date: ${date}` + `\n` +
`tags: [${tags.map(t => t.replace(/[^a-z0-9-_]/ig,'')).join(', ')}]` + `\n` +
`rating: ${isNaN(rating) ? 0 : rating}` + `\n` +
`---\n\n`;

  const md = frontMatter +
`## Ingredients\n\n` + (ing || "_Fill in ingredients_") + `\n\n` +
`## Instructions\n\n` + (ins || "_Fill in instructions_") +
historyBlock + `\n`;

  const status = document.getElementById('status');
  status.textContent = 'Creating…';
  try {
    await createFile(path, md, `Add recipe ${fname}`);
    const link = `/recipes/${fname.replace(/\.md$/, '.html')}`;
    status.innerHTML = `✅ Created: <a href="${link}">${link}</a>`;
  } catch (err) {
    status.textContent = '❌ ' + err.message;
  }
});
</script>
</body>
</html>
