<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Recipes</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 2rem; }
  header { display:flex; gap:1rem; align-items:center; flex-wrap:wrap; }
  input, button, select { padding: 0.5rem 0.75rem; border-radius: 10px; border: 1px solid #ddd; }
  .list { margin-top: 1rem; }
  .card { padding: 0.75rem 1rem; border:1px solid #eee; border-radius:14px; margin-bottom: 0.5rem; display:flex; justify-content:space-between; align-items:center; }
  .meta { font-size: 0.9rem; color:#555; }
  .row { display:flex; gap:0.5rem; align-items:center; }
  a.btn { text-decoration:none; background:#111; color:#fff; padding:0.5rem 0.8rem; border-radius:12px; }
  .muted { color:#666; font-size:0.9rem; }
</style>
</head>
<body>
<header>
  <h1 style="margin:0;">üç≥ My Recipes</h1>
  <a class="btn" href="new.html">+ New Recipe</a>
  <input id="q" type="search" placeholder="Search by title or date (filename)‚Ä¶" aria-label="Search">
  <select id="sort">
    <option value="date_desc">Newest first</option>
    <option value="date_asc">Oldest first</option>
    <option value="title_asc">Title A‚ÜíZ</option>
    <option value="title_desc">Title Z‚ÜíA</option>
  </select>
</header>

<p class="muted">Files are read from <code>rishisareen.github.io/recipes</code> via GitHub API and linked to the GitHub Pages-rendered HTML. Keep filenames like <code>YYYY-MM-DD-title.md</code>.</p>

<div id="count" class="muted"></div>
<div id="list" class="list" role="list"></div>

<script>
const GH_USER = "rishi.sareen";
const GH_REPO = "rishisareen.github.io";
const GH_FOLDER = "recipes";
const GH_TOKEN = "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";

// Minimal slugify for filenames
function slugify(s) {
  return s.toLowerCase().trim()
    .replace(/[^a-z0-9\s-]/g, '')
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-');
}

function parseFromFilename(name) {
  // Expect: YYYY-MM-DD-title.md
  const m = name.match(/^(\d{4}-\d{2}-\d{2})-(.+)\.md$/);
  if (!m) return { date: '', title: name.replace('.md',''), name };
  const date = m[1];
  const title = m[2].replace(/-/g, ' ');
  return { date, title, name };
}

async function fetchRecipes() {
  const url = `https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${GH_FOLDER}`;
  const res = await fetch(url, {
    headers: { "Authorization": `token ${GH_TOKEN}` }
  });
  if (!res.ok) throw new Error('Failed to load recipes list');
  const data = await res.json();
  // Keep only .md files
  return data.filter(x => x.type === 'file' && x.name.endsWith('.md'));
}

function renderList(items) {
  const list = document.getElementById('list');
  const count = document.getElementById('count');
  list.innerHTML = '';
  count.textContent = `${items.length} recipe(s)`;

  for (const it of items) {
    const meta = parseFromFilename(it.name);
    const linkTarget = `/recipes/${it.name.replace(/\.md$/, '.html')}`; // Jekyll output
    const row = document.createElement('div');
    row.className = 'card';
    row.innerHTML = `
      <div>
        <a href="${linkTarget}"><strong>${meta.title}</strong></a>
        <div class="meta">${meta.date}</div>
      </div>
      <div class="row">
        <a class="btn" href="update.html?file=${encodeURIComponent(it.name)}">Update</a>
        <a class="btn" href="https://github.com/${GH_USER}/${GH_REPO}/blob/main/${GH_FOLDER}/${it.name}" target="_blank" rel="noopener">Source</a>
      </div>`;
    list.appendChild(row);
  }
}

function sortItems(files, mode) {
  const parsed = files.map(f => ({ raw: f, ...parseFromFilename(f.name) }));
  if (mode === 'date_desc') parsed.sort((a,b) => b.date.localeCompare(a.date));
  if (mode === 'date_asc') parsed.sort((a,b) => a.date.localeCompare(b.date));
  if (mode === 'title_asc') parsed.sort((a,b) => a.title.localeCompare(b.title));
  if (mode === 'title_desc') parsed.sort((a,b) => b.title.localeCompare(a.title));

  return parsed.map(p => p.raw);
}

function filterItems(files, q) {
  const s = q.toLowerCase().trim();
  if (!s) return files;
  return files.filter(f => {
    const meta = parseFromFilename(f.name);
    return meta.title.toLowerCase().includes(s) || meta.date.includes(s);
  });
}

(async function init() {
  try {
    const files = await fetchRecipes();
    const qEl = document.getElementById('q');
    const sortEl = document.getElementById('sort');

    function refresh() {
      const filtered = filterItems(files, qEl.value || '');
      const sorted = sortItems(filtered, sortEl.value);
      renderList(sorted);
    }

    qEl.addEventListener('input', refresh);
    sortEl.addEventListener('change', refresh);
    refresh();
  } catch (e) {
    document.getElementById('list').textContent = 'Error loading recipes: ' + e.message;
  }
})();
</script>
</body>
</html>
