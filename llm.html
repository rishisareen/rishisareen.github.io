<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Recipe with AI - Recipe Manager</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ AI Recipe Generator</h1>
            <a href="index.html" class="btn back-btn">‚Üê Back to Recipes</a>
        </header>

        <main>
            <div id="error" class="error" style="display: none;"></div>
            <div id="success" class="success" style="display: none;"></div>

            <div class="llm-form">
                <div class="form-group">
                    <label for="apiKey">üîë OpenAI API Key:</label>
                    <input type="password" id="apiKey" class="form-input" placeholder="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" required>
                    <small style="color: rgba(255,255,255,0.7); font-size: 12px; margin-top: 5px; display: block;">Your API key is stored locally and not saved permanently.</small>
                </div>

                <div class="form-group">
                    <label for="recipePrompt">üçΩÔ∏è Recipe Description:</label>
                    <textarea id="recipePrompt" class="form-textarea" placeholder="e.g., A healthy Mediterranean chicken dish with quinoa and roasted vegetables, perfect for a weeknight dinner" required></textarea>
                </div>

                <div class="form-group">
                    <label for="additionalInstructions">‚ú® Additional Requirements (Optional):</label>
                    <textarea id="additionalInstructions" class="form-textarea" placeholder="e.g., Make it vegetarian, include prep/cook times, low sodium, gluten-free, serves 4 people, etc."></textarea>
                </div>

                <div class="form-actions">
                    <button id="generateBtn" class="btn btn-primary">üé® Generate Recipe</button>
                </div>AI API Key:</label>
                    <input type="password" id="apiKey" class="form-input" placeholder="sk-..." required>
                    <small style="color: #7f8c8d; font-size: 12px;">Your API key is stored locally and not saved.</small>
                </div>

                <div class="form-group">
                    <label for="recipePrompt">Recipe Prompt:</label>
                    <textarea id="recipePrompt" class="form-textarea" placeholder="e.g., A healthy Mediterranean chicken dish with quinoa and vegetables" required></textarea>
                </div>

                <div class="form-group">
                    <label for="additionalInstructions">Additional Instructions (Optional):</label>
                    <textarea id="additionalInstructions" class="form-textarea" placeholder="e.g., Make it vegetarian, include prep time, low sodium, etc."></textarea>
                </div>

                <div class="form-actions">
                    <button id="generateBtn" class="btn btn-primary">Generate Recipe</button>
                </div>
            </div>

            <div id="generatedRecipe" style="display: none; margin-top: 30px;">
                <h2>Generated Recipe</h2>
                <div style="margin-bottom: 15px;">
                    <button id="editGeneratedBtn" class="btn btn-success">Edit & Save This Recipe</button>
                    <button id="regenerateBtn" class="btn btn-secondary">Generate Another</button>
                </div>
                <div id="recipePreview" style="background: #f8f9fa; padding: 20px; border-radius: 6px; border: 1px solid #e9ecef; max-height: 400px; overflow-y: auto;"></div>
            </div>
        </main>
    </div>

    <script src="github.js"></script>
    <script>
        const apiKeyInput = document.getElementById('apiKey');
        const recipePromptInput = document.getElementById('recipePrompt');
        const additionalInstructionsInput = document.getElementById('additionalInstructions');
        const generateBtn = document.getElementById('generateBtn');
        const generatedRecipe = document.getElementById('generatedRecipe');
        const recipePreview = document.getElementById('recipePreview');
        const editGeneratedBtn = document.getElementById('editGeneratedBtn');
        const regenerateBtn = document.getElementById('regenerateBtn');
        const error = document.getElementById('error');
        const success = document.getElementById('success');

        let currentGeneratedContent = '';

        // Load saved API key from session storage (temporary)
        const savedApiKey = sessionStorage.getItem('openai_api_key');
        if (savedApiKey) {
            apiKeyInput.value = savedApiKey;
        }

        // Event listeners
        generateBtn.addEventListener('click', generateRecipe);
        editGeneratedBtn.addEventListener('click', editGeneratedRecipe);
        regenerateBtn.addEventListener('click', () => {
            generatedRecipe.style.display = 'none';
        });

        // Save API key to session storage when changed
        apiKeyInput.addEventListener('change', () => {
            if (apiKeyInput.value.trim()) {
                sessionStorage.setItem('openai_api_key', apiKeyInput.value.trim());
            }
        });

        async function generateRecipe() {
            const apiKey = apiKeyInput.value.trim();
            const prompt = recipePromptInput.value.trim();

            if (!apiKey) {
                showError('Please enter your OpenAI API key');
                return;
            }

            if (!prompt) {
                showError('Please enter a recipe prompt');
                return;
            }

            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';
            hideMessages();

            try {
                const recipe = await callOpenAI(apiKey, prompt, additionalInstructionsInput.value.trim());
                currentGeneratedContent = recipe;
                displayGeneratedRecipe(recipe);
                showSuccess('Recipe generated successfully!');
            } catch (err) {
                showError('Failed to generate recipe: ' + err.message);
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate Recipe';
            }
        }

        async function callOpenAI(apiKey, prompt, additionalInstructions) {
            const systemPrompt = `You are a professional chef and recipe writer. Create a detailed recipe in Markdown format. The recipe should include:
1. A clear title (using # heading)
2. Brief description
3. Prep time, cook time, and servings
4. Complete ingredients list with measurements
5. Step-by-step instructions
6. Optional tips or notes

Format the response as clean Markdown that will render nicely. Be specific with measurements and cooking times.`;

            const userPrompt = additionalInstructions 
                ? `Create a recipe for: ${prompt}\n\nAdditional requirements: ${additionalInstructions}`
                : `Create a recipe for: ${prompt}`;

            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    model: 'gpt-3.5-turbo',
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: userPrompt }
                    ],
                    max_tokens: 1500,
                    temperature: 0.7
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`OpenAI API error: ${response.status} ${response.statusText} - ${errorData.error?.message || 'Unknown error'}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        function displayGeneratedRecipe(markdown) {
            // Configure marked options
            marked.setOptions({
                breaks: true,
                gfm: true
            });

            const html = marked.parse(markdown);
            recipePreview.innerHTML = html;
            generatedRecipe.style.display = 'block';
        }

        function editGeneratedRecipe() {
            // Extract filename from generated content
            const title = GitHubAPI.extractTitleFromContent(currentGeneratedContent);
            const filename = title ? GitHubAPI.sanitizeFilename(title) : 'generated-recipe.md';
            
            // Encode the content and redirect to editor
            const encodedContent = encodeURIComponent(currentGeneratedContent);
            window.location.href = `editor.html?content=${encodedContent}&filename=${encodeURIComponent(filename)}`;
        }

        function showError(message) {
            error.textContent = message;
            error.style.display = 'block';
            success.style.display = 'none';
            setTimeout(hideMessages, 5000);
        }

        function showSuccess(message) {
            success.textContent = message;
            success.style.display = 'block';
            error.style.display = 'none';
            setTimeout(hideMessages, 3000);
        }

        function hideMessages() {
            error.style.display = 'none';
            success.style.display = 'none';
        }

        // Load content from URL parameters if coming from LLM generation
        const contentParam = urlParams.get('content');
        const filenameParam = urlParams.get('filename');
        
        if (contentParam) {
            try {
                markdownEditor.value = decodeURIComponent(contentParam);
                updatePreview();
                if (filenameParam) {
                    filenameInput.value = decodeURIComponent(filenameParam);
                }
            } catch (err) {
                showError('Failed to load generated content');
            }
        }
    </script>
</body>
</html>
