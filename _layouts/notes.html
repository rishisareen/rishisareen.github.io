<!DOCTYPE html>
<html lang="en-us">

  {% include head.html %}

  <body class="notes-page">

    <header class="site-header">
      <div class="header-container">
        <a href="{{ site.baseurl }}/" class="site-title">{{ site.author.name }}</a>
        <nav class="site-nav">
          <a class="nav-link{% if page.title == 'Articles' or page.collection == 'articles' %} active{% endif %}" href="{{ '/articles/' | absolute_url }}">Articles</a>
          <a class="nav-link{% if page.title == 'Notes' or page.collection == 'notes' %} active{% endif %}" href="{{ '/notes/' | absolute_url }}">Notes</a>
          <a class="nav-link{% if page.title == 'Photography' or page.collection == 'photography' %} active{% endif %}" href="{{ '/photography/' | absolute_url }}">Photography</a>
          <a class="nav-link{% if page.title == 'About' %} active{% endif %}" href="{{ '/about/' | absolute_url }}">About</a>
        </nav>
      </div>
    </header>

    <button class="mobile-sidebar-toggle" id="mobile-sidebar-toggle">
      <span>â˜°</span> Notes
    </button>

    <div class="notes-layout">
      <aside class="notes-sidebar" id="notes-sidebar">
        <nav class="notes-nav">
          {% assign folders = "" | split: "" %}
          {% assign root_notes = "" | split: "" %}

          {% for note in site.notes %}
            {% assign path_parts = note.path | split: '/' %}
            {% if path_parts.size > 2 %}
              {% assign folder_name = path_parts[1] %}
              {% unless folders contains folder_name %}
                {% assign folders = folders | push: folder_name %}
              {% endunless %}
            {% else %}
              {% assign root_notes = root_notes | push: note %}
            {% endif %}
          {% endfor %}

          {% assign sorted_root = root_notes | sort: "title" %}
          {% for note in sorted_root %}
            <a class="notes-nav-item{% if page.url == note.url %} active{% endif %}" href="{{ site.baseurl }}{{ note.url }}">
              {{ note.title }}
            </a>
          {% endfor %}

          {% assign sorted_folders = folders | sort %}
          {% for folder in sorted_folders %}
            <span class="notes-folder">{{ folder | replace: "_", " " | capitalize }}</span>
            {% assign folder_notes = site.notes | where_exp: "note", "note.path contains folder" | sort: "title" %}
            {% for note in folder_notes %}
              {% assign note_parts = note.path | split: '/' %}
              {% if note_parts[1] == folder %}
                <a class="notes-nav-item notes-nav-child{% if page.url == note.url %} active{% endif %}" href="{{ site.baseurl }}{{ note.url }}">
                  {{ note.title }}
                </a>
              {% endif %}
            {% endfor %}
          {% endfor %}
        </nav>
      </aside>

      <main class="notes-content">
        <article class="note">
          <h1 class="page-title">{{ page.title }}</h1>
          {% if page.date and page.collection == 'notes' %}
          <span class="note-date">{{ page.date | date: "%b %d, %Y" }}</span>
          {% endif %}
          <div class="note-body">
            {{ content }}
          </div>
        </article>

        <aside class="notes-toc-sidebar">
          <nav class="toc" id="notes-toc">
            <h4>Contents</h4>
            <ul id="notes-toc-list"></ul>
          </nav>
        </aside>
      </main>
    </div>

    <script>
    (function() {
      const tocList = document.getElementById('notes-toc-list');
      const tocSidebar = document.querySelector('.notes-toc-sidebar');
      const noteBody = document.querySelector('.note-body');

      if (!tocList || !noteBody) return;

      // Get all headings from the note content
      const headings = noteBody.querySelectorAll('h2, h3');

      // Hide TOC if fewer than 3 headings
      if (headings.length < 3) {
        tocSidebar.style.display = 'none';
        return;
      }

      // Generate TOC
      headings.forEach(function(heading, index) {
        // Add ID to heading if it doesn't have one
        if (!heading.id) {
          heading.id = 'heading-' + index;
        }

        const li = document.createElement('li');
        li.className = 'toc-' + heading.tagName.toLowerCase();

        const a = document.createElement('a');
        a.href = '#' + heading.id;
        a.textContent = heading.textContent;
        a.addEventListener('click', function(e) {
          e.preventDefault();
          heading.scrollIntoView({ behavior: 'smooth' });
          history.pushState(null, null, '#' + heading.id);
        });

        li.appendChild(a);
        tocList.appendChild(li);
      });

      // Highlight current section on scroll
      const tocLinks = tocList.querySelectorAll('a');

      function highlightCurrentSection() {
        let current = '';

        headings.forEach(function(heading) {
          const rect = heading.getBoundingClientRect();
          if (rect.top <= 100) {
            current = heading.id;
          }
        });

        tocLinks.forEach(function(link) {
          link.classList.remove('active');
          if (link.getAttribute('href') === '#' + current) {
            link.classList.add('active');
          }
        });
      }

      window.addEventListener('scroll', highlightCurrentSection);
      highlightCurrentSection();
    })();

    // Sidebar toggle - Lanyon style
    (function() {
      const toggle = document.getElementById('mobile-sidebar-toggle');
      const sidebar = document.getElementById('notes-sidebar');
      const layout = document.querySelector('.notes-layout');

      if (toggle && sidebar && layout) {
        toggle.addEventListener('click', function(e) {
          e.preventDefault();
          sidebar.classList.toggle('show');
          layout.classList.toggle('sidebar-open');
          toggle.classList.toggle('active');
        });
      }
    })();
    </script>

  </body>
</html>
